# 調整さんCSV to ICS コンバーター - 現在の状況と課題

## 1. 発生している問題

### 1.1. `test-chouseisan-converter.ps1`実行時の文字化けとエラー

*   **文字化け:** `pwsh.exe`経由でテストスクリプトを実行すると、標準出力が文字化けする。これはWSL環境とPowerShellの出力エンコーディングの相互作用による表示上の問題である可能性が高い。
*   **エラー:** `Invoke-Command`の引数渡しに関するエラーが発生していたが、**これは解決済み**。
    *   以前のエラー: `Stderr: =: The term '=' is not recognized as a name of a cmdlet, function, script file, or executable program.`
    *   **解決策:** `test-chouseisan-converter.ps1`内の`Invoke-Command`の引数渡しをスプラッティング形式に修正し、`pwsh.exe`の呼び出しコマンドのエスケープを強化したことで解消された。

### 1.2. `Normal_ShiftJIS_NoOptions`テストの失敗 (今後の検討課題)

*   **ICSファイル内容の不一致:** 出力されるICSファイルの内容が期待されるものと異なる。
*   **日付解析警告:** `WARNING: 日付フォーマットを解析できませんでした。スキップします: 7/18() 20:00` のような警告が多数発生している。これは、`chouseisan_shift-jis-dont-erase.csv`の日付フォーマットが正しく解析されていないことを示唆している。
*   **対応方針:** この問題はShift-JISエンコーディングと日付解析の複雑な相互作用に起因すると考えられるため、**一旦「ファーザースタディ（今後の検討課題）」とし、現時点ではUTF-8での動作確認を優先する。**

### 1.3. `run_chouseisan_converter.ps1`実行時の`CsvEncoding`パラメータエラー

*   以前の実行で`Cannot process argument transformation on parameter 'CsvEncoding'. Cannot convert the "" value of type "System.String" to type "System.Text.Encoding".`というエラーが発生した。
*   `run_chouseisan_converter.ps1`と`src/Convert-ChouseisanToIcs.ps1`の修正により、この問題は解決されているはずだが、再確認が必要。

## 2. これまでの修正と成功

*   **`src/Convert-ChouseisanToIcs.ps1`の日付解析正規表現の修正 (複数回):**
    *   `(\d{1,4}/\d{1,2}/\d{1,2})(?:\\(.*?(?:\\))?)?\s*(\d{1,2}:\d{2})(?:〜)?`
    *   を
    *   `(\d{1,4}/\d{1,2}/\d{1,2})(?:\\(.*?\\))?\s*(\d{1,2}:\d{2})(?:〜)?`
    *   さらに
    *   `(\d{1,4}/\d{1,2}/\d{1,2})(?:\(.*\))?\s*(\d{1,2}:\d{2})(?:〜)?`
    *   に変更。
*   **`run_chouseisan_converter.ps1`への`CsvEncoding`選択肢の追加とパラメータ渡しロジックの修正:**
    *   ユーザーがエンコーディングを選択できるようにし、`Convert-ChouseisanToIcs.ps1`に`CsvEncoding`パラメータを渡すように変更。
*   **`test-chouseisan-converter.ps1`の`CsvEncoding`指定を`"shift_jis"`に修正:**
    *   ドキュメント(`docs/csv_specification.md`)の指定に従い、`"ShiftJIS"`から`"shift_jis"`に戻した。
*   **`test-chouseisan-converter.ps1`の`Invoke-Command`引数渡しをスプラッティングで修正:**
    *   `Invoke-Command`への引数渡しをハッシュテーブル（スプラッティング）形式に変更したことで、以前のエラーが解消された。
*   **`pwsh.exe`の呼び出しコマンドのエスケープ強化:**
    *   `bash`から`pwsh.exe`を呼び出す際のコマンドラインのエスケープを強化したことで、`Stderr`のエラーが解消された。

## 3. 残っている課題と今後の対応

*   **`Normal_ShiftJIS_NoOptions`テストの完全な成功:**
    *   上記1.2で述べた通り、一旦「ファーザースタディ」とする。
*   **年が省略された日付の処理ロジックの追加:**
    *   年が省略された日付（例: `7/18`）が現在の日付より過去になる場合、年を1年進めるロジックを`src/Convert-ChouseisanToIcs.ps1`に追加する。
*   **`test.ps1`の修正:**
    *   `src/Convert-ChouseisanToIcs.ps1`のパラメータ定義の誤りを修正しました。
    *   `test.ps1`の構文エラーを修正しました。

---
*This document is generated by Gemini CLI.*

## 4. 追加のデバッグ経緯と解決 (2025年7月25日)

### 4.1. `src/Convert-ChouseisanToIcs.ps1` の `param()` ブロック解析エラーの再発と解決

*   **問題:** `src/Convert-ChouseisanToIcs.ps1` の `param()` ブロックが PowerShell によって正しく解析されない問題が再発しました。エラーメッセージは「Missing closing ')' in expression」や「The assignment expression is not valid」でした。
*   **試行錯誤:** `param()` ブロック内のコンマの有無、明示的なパラメータ属性の追加、スクリプトファイルのエンコーディング確認など、様々な試行錯誤を行いました。
*   **解決策:** `param()` ブロックをスクリプトの**先頭**に配置することで解決しました。これは PowerShell のスクリプト解析の特性によるものでした。この教訓は `docs/development/coding_guidelines.md` に追記済みです。

### 4.2. `Normal_UTF8_NoOptions` テストの時刻解析エラーと解決

*   **問題:** UTF-8 の正常系テストで、ICS ファイル内の時刻が期待通りに解析されず、`DTSTART` や `DTEND` の時刻がずれていました（例: `10:00` が `00:00` になる）。
*   **試行錯誤:** 日付解析に使用する正規表現の調整、`[datetime]::Parse()` から `[datetime]::ParseExact()` へ変更、フォーマット文字列の調整。
*   **解決策:** `[datetime]::ParseExact()` を使用し、フォーマット文字列を `HH:mm` に変更することで、時刻が正しく解析されるようになりました。

### 4.3. `EmptyCsv` テストの警告メッセージキャプチャ問題と解決

*   **問題:** 空の CSV ファイルを処理するテストで、期待される警告メッセージ「CSVファイルにヘッダー行またはデータ行がありません。」がテストの `$result` 変数に正しくキャプチャされず、テストが失敗していました。
*   **試行錯誤:**
    *   `src/Convert-ChouseisanToIcs.ps1` の CSV 行数チェックを `Length -lt 4` に変更。
    *   `test-chouseisan-converter.ps1` の `Run-Test` 関数内で、`Invoke-Command` の呼び出しで `*>&1` を使用してすべてのストリームをキャプチャ。
    *   キャプチャされた警告の `Length` プロパティにアクセスする際に、オブジェクトが配列でない場合のハンドリングを `@($warnings).Length` のように修正。
*   **解決策:** 上記の試行錯誤により、警告メッセージが正しくキャプチャされ、テストが合格するようになりました。

### 4.4. デバッグログの `EncodingName` プロパティ問題と解決

*   **問題:** `src/Convert-ChouseisanToIcs.ps1` のデバッグログ出力で `$CsvEncoding.EncodingName` プロパティにアクセスするとエラーが発生していました。
*   **試行錯誤:** 問題の行をコメントアウト。
*   **解決策:** 問題の行をコメント解除し、`$CsvEncoding.WebName` を使用するように修正しました。これにより、エンコーディング名が正しく表示されるようになりました。

### 4.5. 一時ファイル `test.ps1` のアーカイブ

*   **経緯:** `param()` ブロックのデバッグのために一時的に `test.ps1` ファイルを作成しましたが、問題解決後は不要になったため、削除する代わりに日付をつけて `archive` ディレクトリに移動しました。
*   **ルール:** 今後、一時的に作成したファイルや不要になったファイルは、削除するのではなく、日付をつけて `archive` ディレクトリに移動することを必須ルールとします。

## 5. 現在のテスト状況

*   `Normal_UTF8_NoOptions` テストは合格。
*   `Normal_ShiftJIS_NoOptions` テストは引き続き失敗しており、**ファーザースタディ**として延期。
*   `EmptyCsv` テストは合格。
*   `ErrorFormatCsv` テストは合格。

---


## 4. 追加のデバッグ経緯と解決 (2025年7月25日)

### 4.1. `src/Convert-ChouseisanToIcs.ps1` の `param()` ブロック解析エラーの再発と解決

*   **問題:** `src/Convert-ChouseisanToIcs.ps1` の `param()` ブロックが PowerShell によって正しく解析されない問題が再発しました。エラーメッセージは「Missing closing ')' in expression」や「The assignment expression is not valid」でした。
*   **試行錯誤:** `param()` ブロック内のコンマの有無、明示的なパラメータ属性の追加、スクリプトファイルのエンコーディング確認など、様々な試行錯誤を行いました。
*   **解決策:** `param()` ブロックをスクリプトの**先頭**に配置することで解決しました。これは PowerShell のスクリプト解析の特性によるものでした。この教訓は `docs/development/coding_guidelines.md` に追記済みです。

### 4.2. `Normal_UTF8_NoOptions` テストの時刻解析エラーと解決

*   **問題:** `Normal_UTF8_NoOptions` テストで、ICS ファイル内の時刻が期待通りに解析されず、`DTSTART` や `DTEND` の時刻がずれていました（例: `10:00` が `00:00` になる）。
*   **試行錯誤:** 日付解析に使用する正規表現の調整、`[datetime]::Parse()` から `[datetime]::ParseExact()` への変更、フォーマット文字列の調整。
*   **解決策:** `[datetime]::ParseExact()` を使用し、フォーマット文字列を `HH:mm` に変更することで、時刻が正しく解析されるようになりました。

### 4.3. `EmptyCsv` テストの警告メッセージキャプチャ問題と解決

*   **問題:** `EmptyCsv` テストで、期待される警告メッセージ「CSVファイルにヘッダー行またはデータ行がありません。」がテストの `$result` 変数に正しくキャプチャされず、テストが失敗していました。
*   **試行錯誤:**
    *   `src/Convert-ChouseisanToIcs.ps1` の CSV 行数チェックを `Length -lt 4` に変更。
    *   `test-chouseisan-converter.ps1` の `Run-Test` 関数内で、`Invoke-Command` の呼び出しで `*>&1` を使用してすべてのストリームをキャプチャ。
    *   キャプチャされた警告の `Length` プロパティにアクセスする際に、オブジェクトが配列でない場合のハンドリングを `@($warnings).Length` のように修正。
*   **解決策:** 上記の試行錯誤により、警告メッセージが正しくキャプチャされ、テストが合格するようになりました。

### 4.4. デバッグログの `EncodingName` プロパティ問題と解決

*   **問題:** `src/Convert-ChouseisanToIcs.ps1` のデバッグログ出力で `$CsvEncoding.EncodingName` プロパティにアクセスするとエラーが発生していました。
*   **試行錯誤:** 問題の行をコメントアウト。
*   **解決策:** 問題の行をコメント解除し、`$CsvEncoding.WebName` を使用するように修正しました。これにより、エンコーディング名が正しく表示されるようになりました。

### 4.5. 一時ファイル `test.ps1` の削除

*   **経緯:** `param()` ブロックのデバッグのために一時的に `test.ps1` ファイルを作成しましたが、問題解決後は不要になったため削除しました。

## 5. 現在のテスト状況

*   `Normal_UTF8_NoOptions` テストは合格。
*   `Normal_ShiftJIS_NoOptions` テストは引き続き失敗しており、**ファーザースタディ**として延期。
*   `EmptyCsv` テストは合格。
*   `ErrorFormatCsv` テストは合格。

---
