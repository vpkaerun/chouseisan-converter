# 開発ガイドライン

## 1. プロジェクトの目的と概要

このドキュメントは、調整さんCSV to ICSコンバータープロジェクトにおける開発者向けのガイドライン、コーディング規約、および過去のデバッグから得られた重要な教訓と再発防止策をまとめたものです。プロジェクトの目的は、調整さんからエクスポートしたCSV形式の出欠表を、Outlookなどのカレンダーアプリにインポート可能なiCalendar（.ics）形式のファイルに変換するPowerShellスクリプトを開発することです。

## 2. ファイルおよび`フォルダ`構成ルール

プロジェクトの整合性を保つため、以下のファイルおよび`フォルダ`構成ルールを適用します。

### 2.1. ルート構成

```plaintext
ga/
├── 00_admin/
├── 01_courses/
    ├── 01_ga-morning/  # 朝活講座
    ├── 02_ga-business/ # 企業向け講座
    └── 03_ga-night/   # 夜間講座
├── 02_promotion/      # プロモーション関連
    └── 01_consultation/ # 無料相談会
├── 99_backups/        # 手動バックアップ（非推奨）
```

### 2.2. バックアップ

**99_backups:**

* この`フォルダ`は、過去のファイルを手動で退避させるための場所です。
* **（非推奨）** 今後はGitによるバージョン管理を基本とするため、この`フォルダ`への新規保存は推奨されません。
* AIエージェントは、原則としてこの`フォルダ`内のファイルを通常業務の対象外とします。

**90_logs/archives:**

* この`フォルダ`は、過去のログや特定のファイルをアーカイブするための場所です。
* AIエージェントは、原則としてこの`フォルダ`内のファイルを通常業務の対象外とします。

---

### 2.3. ファイル命名規則

**基本フォーマット（日次更新されるファイル）**:

`YYYYMMDD_HHMM-Type-Keyword[-CourseCode]-ga.md`

<!--#### 各要素の解説 -->

* **`YYYYMMDD_HHMM`**: **年月日と時分（13桁）**
  * 例: `20250706_1030`
  * 日中の複数回更新や、作成順序の明確化に使用します。
* **`Type`**: **ファイル種別（小文字英語、ハイフンなし）**
  * 例: `plan`, `masterplan`, `execplan`, `outline`, `slide`, `memo`, `report`, `prompt`, `event`, `survey`, `guide`, `rule`, `task`, `ref`, `template`
  * ファイルの主要な性質を表す単一の単語を使用します。
* **`Keyword`**: **内容を表すキーワード（小文字英語、ハイフン区切り）**
  * 例: `online-course-operation`, `self-expression`, `gemini-cli-intro`, `current-ai-topics`, `peatix-july-2025-draft`
  * 必要に応じて複数の単語をハイフンで繋ぎます。
* **`[-CourseCode]`**: **コースコード（小文字英数字、オプション）**
  * 例: `-core101`, `-spot201`
  * 特定のコースに関連する場合にのみ使用し、ハイフンで区切ります。
* **`-ga.md`**: **プロジェクト識別子と拡張子**
  * 例: `-ga.md`

### 2.4. 補足

* 日次で更新されない、またはタイムスタンプが重要でないファイル（例: `50_templates/` 内の汎用テンプレートなど）は、この限りではありません。
* ファイル名が長くなりすぎる場合は、`Keyword` や `CourseCode` を簡潔にするか、ファイル内容で詳細を補足してください。

---

<!-- # 開発ガイドライン -->

## 3. コーディング規約とベストプラクティス

### 3.1. PowerShell スクリプト開発

#### 3.1.1. `param()` ブロックの配置

* **ルール:** `param()` ブロックは、スクリプトの**最先頭**に配置してください。
* **理由:** PowerShellは `param()` ブロックをスクリプトの先頭で解析します。これより前に他のコード（変数宣言、関数定義、`Set-StrictMode` など）があると、解析エラーが発生する可能性があります。
* **再発防止:** このルールを破ると、`ParserError` が発生する可能性があります。

#### 3.1.2.` パラメータ`の型指定とデフォルト値

* **ルール:** スクリプトの`パラメータ`には、可能な限り厳密な型指定を行ってください。デフォルト値がない場合は、その旨を明記するか、`必須パラメータ`であることを明確にしてください。
* **理由:** 型の不一致によるエラー（例: 文字列から `System.Text.Encoding` への変換エラー）を防ぎます。
* **再発防止:** `run_chouseisan_converter.ps1` で発生した `CsvEncoding` `パラメータ`のエラーは、このルールの重要性を示しています。

#### 3.1.3. 出力ストリームのハンドリング

* **ルール:** スクリプトの出力をキャプチャする際は、成功ストリームだけでなく、エラー、警告、デバッグストリームも考慮し、適切にリダイレクト（`*>&1`）およびフィルタリングしてください。
* **理由:** エラーや警告を見逃さず、テストの信頼性を高めるためです。
* **再発防止:** `test-chouseisan-converter.ps1` での警告メッセージキャプチャ問題は、ストリームハンドリングの重要性を示しています。`@($variable).Length` のような配列キャストも有効な手段です。

#### 3.1.4. `replace` ツールの使用法

* **ルール:** `replace` ツールを使用する際は、`old_string` がターゲットファイル内の内容と**完全に一致する**ことを確認してください。これには、空白、インデント、改行コード、特殊文字も含まれます。
* **理由:** 不一致による置換失敗を防ぐためです。
* **再発防止:** 操作前に `read_file` で最新の内容を確認し、`old_string` を正確にコピーして使用してください。変更範囲は最小限に留め、`expected_replacements` `パラメータ`を適切に指定してください。

#### 3.1.5. デバッグログの安全性

* **ルール:** デバッグログでオブジェクトのプロパティにアクセスする際は、プロパティが存在しない場合のエラーを避けるため、`$($Object.ToString())` や `$($Object)` のように、オブジェクトの文字列表現を出力する方法を優先してください。
* **理由:** スクリプトの実行中に予期せぬエラーが発生するのを防ぐためです。
* **再発防止:** `$CsvEncoding.EncodingName` のようなプロパティアクセスは、オブジェクトのライフサイクルによっては失敗する可能性があるため、注意が必要です。

#### 3.1.6. 複雑なロジックの単体テスト

* **ルール:** 正規表現、日付解析、複雑なフィルタリングロジックなど、複雑な処理は、本体コードに組み込む前に、**専用の最小限の `test.ps1` スクリプトで単体テストを徹底**してください。
* **理由:** 問題の早期発見と、修正の検証を効率化するためです。
* **再発防止:** 今回の正規表現の単体テスト成功が、このアプローチの有効性を示しました。

## 4. デバッグで得られた重要な教訓と再発防止策

### 4.1. PowerShell の `param()` ブロック解析エラーの再発と解決

* **問題:** `param()` ブロックがスクリプトの先頭にないと解析エラーが発生する。
* **解決策:** `param()` ブロックをスクリプトの最先頭に配置する。
* **教訓:** PowerShellの構文規則は厳密であり、`param()` ブロックの配置は非常に重要です。

### 4.2. `Normal_UTF8_NoOptions` テストの時刻解析エラーと解決

* **問題:** 時刻解析で `[datetime]::Parse()` が期待通りに動作せず、時刻がずれる。
* **解決策:** `[datetime]::ParseExact()` を使用し、フォーマット文字列を `HH:mm` に変更する。
* **教訓:** 日付/時刻の解析には、`ParseExact` を使用し、フォーマット文字列を正確に指定することが重要です。

### 4.3. `EmptyCsv` テストの警告メッセージキャプチャ問題と解決

* **問題:** 警告メッセージが `$result` 変数に正しくキャプチャされない。
* **解決策:** `Invoke-Command` で `*>&1` を使用し、すべてのストリームをキャプチャ。キャプチャされた変数は `@(...)` で配列にキャストしてからプロパティにアクセスする。
* **教訓:** PowerShellのストリーム処理とオブジェクトの型安全な操作を理解することが重要です。

### 4.4. デバッグログの `EncodingName` プロパティ問題と解決

* **問題:** デバッグログで `$CsvEncoding.EncodingName` にアクセスするとエラーが発生する。
* **解決策:** `$CsvEncoding.WebName` を使用するか、`$($CsvEncoding.ToString())` で出力する。
* **教訓:** オブジェクトのプロパティは、実行コンテキストによって利用できない場合があるため、安全な出力方法を検討する。

### 4.5. `run_chouseisan_converter.ps1` の `CsvEncoding` `パラメータ`型変換エラー

* **問題:** 文字列のエンコーディング名を `System.Text.Encoding` オブジェクトに変換せずに渡していた。
* **解決策:** `[System.Text.Encoding]::GetEncoding（）` を使用して文字列をオブジェクトに変換してから渡す。
* **教訓:** `パラメータ`の型を厳密に合わせることが重要です。

### 4.6. `chouseisan_utf-8-dont-erase.csv` の日付解析正規表現の不備

* **問題:** 年が省略された日付形式 (`MM/DD`) が正規表現で正しく解析されない。
* **解決策:** 正規表現を `((?:
\d{1,4}/)?\d{1,2}/\d{1,2})(?:.*)?\s*(\d{2}:\d{2})(?:.*)?` に修正する。
* **教訓:** 複雑なパターンマッチングは、事前に単体テストで検証することが不可欠です。

## 5. 今後の開発における注意点

* **ドキュメントの更新:** 新しい機能追加や仕様変更があった場合は、関連するドキュメント（`project_handbook.md`, `development_guidelines.md`, `csv_specification.md` など）を速やかに更新する。
* **テストの追加:** 新機能や修正には、必ず対応するテストケースを追加し、既存のテストスイートを維持・強化する。
* **ファイル管理:** 一時ファイルや不要なファイルは、削除せずに `archive/` ディレクトリに日付をつけて移動するルールを遵守する。
* **WSL 環境での文字化け:** PowerShellの出力における文字化けは、表示上の問題として認識し、スクリプトの機能に影響しない限り、許容する。ただし、デバッグログの出力方法には注意を払う。
