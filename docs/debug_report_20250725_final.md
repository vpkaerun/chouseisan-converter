# **調整さんCSV to ICS コンバーター - デバッグ状況レポート (2025年7月25日)**

## 1. プロジェクト概要

「調整さん」からエクスポートしたCSV形式の出欠表を、Outlookなどのカレンダーアプリにインポート可能なiCalendar（.ics）形式のファイルに変換するPowerShellスクリプトです。

## 2. 開発環境

* **ホストOS:** Windows 11 Home
* **WSLバージョン:** WSL 2
* **WSLディストリビューション:** Ubuntu 24.04
* **CLIツール:** Gemini CLI
* **ターゲットPowerShellバージョン:** PowerShell 7.5.2 (WSL 2 経由で `pwsh.exe` を呼び出し)

## 3. 発生している問題とこれまでの試行錯誤、および解決

これまでのデバッグセッションで直面した主要な問題と、その解決策を以下にまとめます。

### 3.1. 永続的な文字化け問題 (stdout/stderr)

* **問題:** `pwsh.exe` を WSL 2 (Ubuntu 24.04) から呼び出してPowerShellスクリプトを実行すると、標準出力 (stdout) および標準エラー出力 (stderr) の日本語が常に文字化けします。
* **試行錯誤:** `$OutputEncoding` の設定、スクリプトファイルのエンコーディング確認など。
* **解決状況:** 解決していません。これは WSL と PowerShell の出力エンコーディングの相互作用による表示上の問題である可能で能性が高く、現在の環境では解決が困難と判断し、スクリプトの機能には影響しないため、この問題は無視して進めています。

### 3.2. `src/Convert-ChouseisanToIcs.ps1` の `param()` ブロック解析エラー

* **問題:** `param()` ブロックが PowerShell によって正しく解析されず、「Missing closing ')' in expression」や「The assignment expression is not valid」といった `ParserError` が発生していました。
* **試行錯誤:** `param()` ブロック内のコンマの有無、明示的なパラメータ属性の追加、スクリプトファイルのエンコーディング確認、`param()` ブロックのみのテスト。
* **解決策:** `param()` ブロックをスクリプトの**先頭**に配置することで解決しました。これは PowerShell のスクリプト解析の特性によるものでした。この教訓は `docs/development/coding_guidelines.md` に追記済みです。

### 3.3. `Normal_UTF8_NoOptions` テストの失敗

* **問題:** UTF-8 の正常系テストで、ICS ファイル内の時刻が期待通りに解析されず、`DTSTART` や `DTEND` の時刻がずれていました（例: `10:00` が `00:00` になる）。
* **試行錯誤:** 日付解析に使用する正規表現の調整、`[datetime]::Parse()` から `[datetime]::ParseExact()` への変更、フォーマット文字列の調整。
* **解決策:** `[datetime]::ParseExact()` を使用し、フォーマット文字列を `HH:mm` に変更することで、時刻が正しく解析されるようになりました。

### 3.4. `Normal_ShiftJIS_NoOptions` テストの失敗

* **問題:** Shift-JIS エンコーディングのテストで、ICS ファイルの内容が期待されるものと異なり、日付解析に関する警告が多数発生しています（例: 「日付フォーマットを解析できませんでした。」）。
* **試行錯誤:** 日付解析の正規表現を調整。
* **解決状況:** `reflection.md` に記載されている通り、この問題は Shift-JIS エンコーディングと日付解析の複雑な相互作用に起因すると考えられ、現在の文字化け問題の解決が困難な状況も踏まえ、**ファーザースタディ（今後の検討課題）**として延期しています。

### 3.5. `EmptyCsv` テストの失敗

* **問題:** 空の CSV ファイルを処理するテストで、期待される警告メッセージ「CSVファイルにヘッダー行またはデータ行がありません。」が標準出力に表示されず、テストが失敗していました。
* **試行錯誤:**
  * `src/Convert-ChouseisanToIcs.ps1` の CSV 行数チェックを `Length -lt 4` に変更。
  * `Invoke-Command` の呼び出しで `*>&1` を使用してすべてのストリームをキャプチャ。
  * `test-chouseisan-converter.ps1` の `Run-Test` 関数内で、キャプチャされた警告の `Length` プロパティにアクセスする際に、オブジェクトが配列でない場合のハンドリングを `@($warnings).Length` のように修正。
* **解決策:** 上記の試行錯誤により、警告メッセージが正しくキャプチャされ、テストが合格するようになりました。

### 4. 現在の状況

* `test.ps1` (最小限の `param()` ブロックテスト) は正常に動作します。
* `Normal_UTF8_NoOptions` テストは合格しました。
* `Normal_ShiftJIS_NoOptions` テストは引き続き失敗しており、延期されています。
* `EmptyCsv` テストは合格しました。
* `ErrorFormatCsv` テストも合格しました。
* ターミナル出力の文字化けは解決していません。

### 5. 今後のステップ

* `src/Convert-ChouseisanToIcs.ps1` のデバッグログのコメントアウトを元に戻し、`$CsvEncoding.EncodingName` の問題を修正する。
* `test.ps1` を元の状態に戻すか、削除する。
* 最終的な組み上げと確認。
