# 01 要件定義書

## 1. 概要

調整さんからエクスポートしたCSVファイルを解析し、iCalendar（.ics）形式のファイルを生成するPowerShellスクリプトを開発する。本スクリプトは、汎用性、堅牢性、単体運用性を高め、最終的に技術ブログ（Qiita等）で公開可能な品質を目指す。

## 2. 機能要件

### 2.1. 基本機能

- CSVファイルを読み込み、ICSファイルを生成する。
- CSVの1行目を、各カレンダーイベントの件名（`SUMMARY`）として使用する。
- 日程と参加可否（◯, △, ×）を解析し、条件に合致するイベントのみをICSファイルに出力する。
- 生成されるICSイベントは「仮の予定」（`STATUS:TENTATIVE`）として設定する。

### 2.2. 入力（CSV）

- **デフォルトファイル:** スクリプトと同じディレクトリにある `chouseisan.csv` をデフォルトの入力ファイルとする。
- **エンコーディング:** Shift-JISとして読み込む。
- **構造:**
  - 1行目: イベントの件名
  - 2行目: ヘッダー行 (`日程`, `参加者1`, `参加者2`, ...)
  - 3行目以降: データ行 (`YYYY/MM/DD(ddd) HH:MM〜`, `◯`, `△`, `×`, ...)
- **オプション:**
  - `-CsvPath <String>`: 読み込むCSVファイルのパスを明示的に指定できる。

### 2.3. 出力（ICS）

- **デフォルトファイル:** `output.ics` という名称で、スクリプトと同じディレクトリに出力する。
- **エンコーディング:** UTF-8
- **オプション:**
  - `-IcsPath <String>`: 出力するICSファイルのパスを明示的に指定できる。

### 2.4. 参加可否のフィルタリングオプション

- **`-IgnoreOthers` スイッチ:**
  - このオプションが指定された場合、自分（スクリプト実行者）の出欠のみを考慮する。CSVの3列目（最初の参加者列）を自分の列とみなし、そこが `◯` または `△` の行のみをイベントとして登録する。
- **`-ExcludeNG` スイッチ:**
  - このオプションが指定された場合、いずれかの参加者が `×` を付けている日程は、たとえ他の参加者が `◯` であってもICSに登録しない。

### 2.5. 堅牢性

- 入力CSVファイルが存在しない場合、エラーメッセージを表示して処理を中断する。
- 日付や時刻の解析に失敗した場合、該当行をスキップし、エラーメッセージを表示する。
- データ行が1行も存在しないCSVでも、エラーなく処理を完了する。

## 3. 実行環境

### 3.1. 必須環境

- **PowerShell 7.5.2 以上**

本スクリプトは PowerShell 7.5.2 以上を必須の実行環境とします。
Windowsに標準搭載されている Windows PowerShell 5.1 以前では、文字コードの扱いやコマンドレットの挙動が異なる可能性があるため、動作保証外とします。

### 3.2. 環境設定

PowerShellスクリプトの実行がセキュリティポリシーによって制限されている場合があります。スクリプトを実行する前に、以下のコマンドを**管理者として実行したPowerShell**で一度だけ実行し、実行ポリシーを緩和してください。

```powershell
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
```

- この設定により、ローカルで作成されたスクリプト（本スクリプトを含む）と、信頼できる発行元によって署名されたスクリプトの実行が許可されます。
- `-Scope CurrentUser` により、この設定は現在ログインしているユーザーにのみ適用され、システム全体の設定には影響しません。

## 4. 非機能要件

### 3.1. 開発・運用

- **デバッグ:**
  - `-Debug` スイッチを付与して実行すると、各処理ステップでの変数の中身や判定結果などを詳細にコンソールに出力する。
- **テスト:**
  - 正常系・異常系を含む複数のテストケースを想定したサンプルCSVデータ (`testdata` `フォルダ`に格納）を準備する。
  - テストを自動実行するスクリプト (`test.ps1`) を用意する。
- **テンプレート化:**
  - 同様のスクリプト開発に再利用できるよう、設定ファイルや`フォルダ`構成をテンプレートとして整理し、`template` `フォルダ`に格納する。
- **レジューム機能:**
  - スクリプトが予期せず中断された場合に備え、処理の進捗をログファイル（`run.log`）に記録する。
  - `README.md` に、中断した場合の確認事項や手動での再開手順を記載する。

### 3.2. ドキュメント

- **`README.md`:** プロジェクト概要、使い方、オプション、レジューム手順などを記載する。
- **スクリプト内コメント:** スクリプトの主要な処理ブロックには、その目的やロジックを説明するコメントを付与する。

## 4. プロジェクト構成（案）

```plaintext
/ (project_root)
|
├── 01_requirements.md  (本書)
├── 02_design.md        (基本設計書)
├── README.md           (プロジェクト説明書)
|
├── src/
│   └── Convert-ChouseisanToIcs.ps1 (メインスクリプト)
|
├── testdata/
│   ├── normal.csv          (正常系テストデータ)
│   ├── empty.csv           (空のCSV)
│   └── error_format.csv    (不正フォーマットデータ)
|
├── template/
│   ├── config.json.template
│   └── run.ps1.template
|
├── chouseisan.csv      (デフォルト入力)
├── output.ics          (デフォルト出力)
├── test.ps1            (テスト実行スクリプト)
└── run.log             (実行ログ)
```
