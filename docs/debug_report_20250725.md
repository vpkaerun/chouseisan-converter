### **調整さんCSV to ICS コンバーター - デバッグ状況レポート**

**1. プロジェクト概要**

「調整さん」からエクスポートしたCSV形式の出欠表を、Outlookなどのカレンダーアプリにインポート可能なiCalendar（.ics）形式のファイルに変換するPowerShellスクリプトです。

**2. 開発環境**

*   **ホストOS:** Windows 11 Home
*   **WSLバージョン:** WSL 2
*   **WSLディストリビューション:** Ubuntu 24.04
*   **CLIツール:** Gemini CLI
*   **ターゲットPowerShellバージョン:** PowerShell 7.5.2 (WSL 2 経由で `pwsh.exe` を呼び出し)

**3. 発生している問題とこれまでの試行錯誤**

現在、PowerShellスクリプトの実行とテストにおいて、いくつかの課題に直面しています。

**3.1. 永続的な文字化け問題 (stdout/stderr)**

*   **問題:** `pwsh.exe` を WSL 2 (Ubuntu 24.04) から呼び出してPowerShellスクリプトを実行すると、標準出力 (stdout) および標準エラー出力 (stderr) の日本語が常に文字化けします。
*   **試行錯誤:**
    *   `pwsh.exe -Command "$OutputEncoding = [System.Text.Encoding]::UTF8; ..."` のように `$OutputEncoding` を明示的に設定。
    *   スクリプトファイル自体のエンコーディングを UTF-8 で書き直す。
*   **現状:** 解決していません。これは WSL と PowerShell の出力エンコーディングの相互作用による表示上の問題である可能性が高く、現在の環境では解決が困難と判断しています。スクリプトの機能には影響しないため、この問題は無視して進めています。

**3.2. `src/Convert-ChouseisanToIcs.ps1` の `param()` ブロック解析エラー (解決済み)**

*   **問題:** `src/Convert-ChouseisanToIcs.ps1` の `param()` ブロックが PowerShell によって正しく解析されず、「Missing closing ')' in expression」や「The assignment expression is not valid」といった `ParserError` が発生していました。
*   **試行錯誤:**
    *   `param()` ブロック内のコンマの有無を何度も変更。
    *   `[Parameter(Mandatory=$false)]` のような明示的なパラメータ属性の追加。
    *   スクリプトファイルのエンコーディングを UTF-8 で書き直す。
    *   `test.ps1` を使用して、`param()` ブロックのみを切り出してテスト。
*   **解決策:** `param()` ブロックをスクリプトの**先頭**に配置することで解決しました。これは PowerShell のスクリプト解析の特性によるものでした。この教訓は `docs/development/coding_guidelines.md` に追記済みです。

**3.3. `Normal_UTF8_NoOptions` テストの失敗 (解決済み)**

*   **問題:** UTF-8 の正常系テストで、ICS ファイル内の時刻が期待通りに解析されず、`DTSTART` や `DTEND` の時刻がずれていました（例: `10:00` が `00:00` になる）。
*   **試行錯誤:**
    *   日付解析に使用する正規表現をより柔軟なものに変更。
    *   `[datetime]::Parse()` から `[datetime]::ParseExact()` に変更し、フォーマット文字列を明示的に指定。
    *   フォーマット文字列を `H:mm` から `HH:mm` に変更。
*   **解決策:** フォーマット文字列を `HH:mm` に変更することで、時刻が正しく解析されるようになりました。

**3.4. `Normal_ShiftJIS_NoOptions` テストの失敗 (延期)**

*   **問題:** Shift-JIS エンコーディングのテストで、ICS ファイルの内容が期待されるものと異なり、日付解析に関する警告が多数発生しています（例: 「日付フォーマットを解析できませんでした。」）。
*   **試行錯誤:** 日付解析の正規表現を調整。
*   **現状:** `reflection.md` に記載されている通り、この問題は Shift-JIS エンコーディングと日付解析の複雑な相互作用に起因すると考えられ、現在の文字化け問題の解決が困難な状況も踏まえ、一旦「ファーザースタディ（今後の検討課題）」として延期しています。

**3.5. `EmptyCsv` テストの失敗 (未解決)**

*   **問題:** 空の CSV ファイルを処理するテストで、期待される警告メッセージ「CSVファイルにヘッダー行またはデータ行がありません。」が標準出力に表示されず、テストが失敗します。
*   **試行錯誤:**
    *   `Invoke-Command` の呼び出しで `2>&1` を使用してエラーと警告をキャプチャ。
    *   `*>&1` を使用してすべてのストリームをキャプチャ。
    *   警告ストリームを個別の変数にリダイレクトする試み。
*   **現状:** 警告メッセージがテストの `$result` 変数に正しくキャプチャされていないようです。PowerShell のストリームリダイレクトと `Invoke-Command` の組み合わせにおける警告ストリームのキャプチャ方法に問題がある可能性があります。

**4. 現在の状況**

*   `test.ps1` (最小限の `param()` ブロックテスト) は正常に動作します。
*   `Normal_UTF8_NoOptions` テストは合格しました。
*   `Normal_ShiftJIS_NoOptions` テストは引き続き失敗しており、延期されています。
*   `EmptyCsv` テストは警告メッセージのキャプチャの問題で失敗しています。
*   ターミナル出力の文字化けは解決していません。

**5. 他の生成AIへの質問**

上記の背景を踏まえ、特に `EmptyCsv` テストの失敗（警告メッセージのキャプチャ）について、PowerShell のストリームリダイレクトと `Invoke-Command` を使用して、警告ストリームを確実にキャプチャするためのベストプラクティスや、考えられる原因、解決策についてアドバイスをいただきたいです。
