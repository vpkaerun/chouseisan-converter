# プロジェクトハンドブック - 調整さんCSV to ICS コンバーター

## 1. 概要

本ツールは、「調整さん」からエクスポートしたCSV形式の出欠表を、Outlookなどのカレンダーアプリにインポート可能なiCalendar（.ics）形式のファイルに変換するPowerShellスクリプトです。

このツールを利用することで、複数の候補日から参加可能な日時だけを抽出し、一括で「仮の予定」としてカレンダーに登録できます。

## 2. 主な機能

- **CSVからICSへの変換:** 調整さん形式のCSV（UTF-8エンコーディング）を読み込み、ICSファイルを生成します。
- **件名の自動設定:** CSVの1行目をイベントの件名として自動で設定します。
- **参加可能日の抽出:** 出欠が「◯」または「△」の候補日のみを抽出します。
- **仮の予定として登録:** 生成されるカレンダーイベントは、すべて「仮の予定」(`TENTATIVE`) として登録されます。
- **デバッグモード:** `-Debug` スイッチで、処理の詳細な流れをコンソールで確認できます。
  * **注意:** `-ExcludeNG` および `-IgnoreOthers` オプションは現在開発中であり、今後のバージョンでサポートされる予定です。

## 3. 必須環境

本スクリプトの実行には、以下の環境と設定が必要です。

- **PowerShell 7.5.2 以上**
  本スクリプトは、`pwsh.exe` での実行を前提としています。Windows標準の `powershell.exe` (5.1以前) では動作しません。

### 実行ポリシーの設定

初めてスクリプトを実行する前に、PowerShellの実行ポリシーを緩和する必要があります。
**管理者として起動したPowerShell**で、以下のコマンドを一度だけ実行してください。

```powershell
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
```

### PowerShell実行時のエンコーディングに関する注意点 (WSL環境)

WSL (Windows Subsystem for Linux) 環境から `pwsh.exe` を呼び出す場合、文字コードの不一致による文字化けが発生することがあります。これを避けるためには、PowerShellプロセス自体のエンコーディングを明示的に設定することが重要です。

**推奨される呼び出し方 (WSL/cmd.exe からのUTF-8出力):**

```bash
pwsh.exe -NoProfile -ExecutionPolicy Bypass -Command "$OutputEncoding = [System.Text.Encoding]::UTF8; & 'C:\Path\To\Your\Script.ps1' -Param1 Value1"
```

## 4. 使い方

### 基本的な使い方

スクリプトと同じディレクトリに `chouseisan_utf-8-dont-erase.csv` を置いて、以下のコマンドを実行します。
`output.ics` というファイルが生成されます。

```powershell
./src/Convert-ChouseisanToIcs.ps1 -CsvPath ./chouseisan_utf-8-dont-erase.csv -IcsPath ./output.ics -CsvEncoding utf-8
```

### パラメータ一覧

| パラメータ         | 型      | 説明                                                                  |
| ------------------ | ------- | --------------------------------------------------------------------- |
| `-CsvPath <path>`  | string  | 入力するCSVファイルのパスを指定します。                                 |
| `-IcsPath <path>`  | string  | 出力するICSファイルのパスを指定します。                                 |
| `-CsvEncoding <encoding>` | string  | 入力するCSVファイルのエンコーディングを指定します（現在UTF-8のみ対応）。 |
| `-Debug`           | switch  | 処理の詳細なデバッグログをコンソールに出力します。                      |

### 実行例

**例1: 入力と出力のパスを明示的に指定する**

```powershell
./src/Convert-ChouseisanToIcs.ps1 -CsvPath ./testdata/normal.csv -IcsPath ./my-schedule.ics -CsvEncoding utf-8
```

## 5. 入力CSVの仕様

本スクリプトが想定するCSV構造は、「調整さん」からエクスポートされるCSVファイルに特有のものです。一般的なCSVファイルとは異なり、**2行目が空行**である点に注意してください。

```csv
(1行目) ここにイベントの件名が入ります
(2行目) 
(3行目) 日程,参加者A,参加者B,参加者C
(4行目以降) 2025/08/01(金) 10:00〜,◯,△,×
2025/08/02(土) 11:00〜,◯,◯,◯
...
```

*   **1行目:** カレンダーに登録されるイベントの **件名** になります。
*   **2行目:** 空行です。
*   **3行目:** ヘッダー行です。「日程」という列と、参加者名が続きます。
*   **4行目以降:** 候補日と、各参加者の出欠（◯, △, ×）が入ります。
    *   年が省略された日付（例: `7/18(木) 20:00〜`）の場合、スクリプト実行時の現在年を補完します。補完された日付が現在の日付よりも過去になる場合、自動的に年を1年進めて「次の開催日」として扱います。

### エンコーディング

本スクリプトは、**UTF-8エンコーディングのCSVファイルのみ**を想定しています。

## 6. プロジェクト要件 (主要な点)

### 6.1. 基本機能

- CSVファイルを読み込み、ICSファイルを生成する。
- CSVの1行目を、各カレンダーイベントの件名（`SUMMARY`）として使用する。
- 日程と参加可否（◯, △, ×）を解析し、条件に合致するイベントのみをICSファイルに出力する。
- 生成されるICSイベントは「仮の予定」（`STATUS:TENTATIVE`）として設定する。

### 6.2. 堅牢性

- 入力CSVファイルが存在しない場合、エラーメッセージを表示して処理を中断する。
- 日付や時刻の解析に失敗した場合、該当行をスキップし、警告メッセージを表示する。
- データ行が1行も存在しないCSVでも、エラーなく処理を完了する。

---
*This tool is developed with the assistance of Gemini CLI.*
